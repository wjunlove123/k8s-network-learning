# kk exec -it ds/cilium -- cilium status --verbose

KubeProxyReplacement Details:
  Status:                 Strict
  Socket LB:              Enabled // This feature.描述的内容是在Socket处直接把后端的Pod地址解析出来。这样就避免在后期做NAT，这有别于多数Service的模式。
                                  // 具体参考：./'Cilium 1.6_ KVstore-free operation, 100_ kube-proxy replacement, Socket-based load-balancing, Generic CNI Chaining, Native AWS ENI support, ... (2_13_2023 11_21_38 AM).html',此能力是KubeProxyReplacement下的一个默认开启能力，在早期版本中叫:hostServiceReachable,目前已经被：.socketLB.enabled替代。
  Socket LB Tracing:      Enabled
  Devices:                eth0 172.18.0.3 (Direct Routing)
  Mode:                   SNAT
  Backend Selection:      Random
  Session Affinity:       Enabled
  Graceful Termination:   Enabled
  NAT46/64 Support:       Disabled
  XDP Acceleration:       Disabled
  Services:
  - ClusterIP:      Enabled
  - NodePort:       Enabled (Range: 30000-32767) 
  - LoadBalancer:   Enabled 
  - externalIPs:    Enabled 
  - HostPort:       Enabled



对比：
# 1. Flannel HOST-GW模式： SYN的发送为：172.18.0.2:32000这样的一个地址！那么此时需要到内核后经过iptable进行NAT转换。
root@flannel-host-gw-control-plane:~# tcpdump -pne -i veth23a2fdc8
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on veth23a2fdc8, link-type EN10MB (Ethernet), snapshot length 262144 bytes
04:59:54.537275 6a:1e:70:73:90:06 > ae:f5:e8:e9:2c:91, ethertype IPv4 (0x0800), length 74: 10.244.0.2.34906 > 172.18.0.2.32000: Flags [S], seq 1836912532, win 64240, options [mss 1460,sackOK,TS val 422097012 ecr 0,nop,wscale 7], length 0
04:59:54.537453 ae:f5:e8:e9:2c:91 > 6a:1e:70:73:90:06, ethertype IPv4 (0x0800), length 74: 172.18.0.2.32000 > 10.244.0.2.34906: Flags [S.], seq 593328729, ack 1836912533, win 65160, options [mss 1460,sackOK,TS val 2107699309 ecr 422097012,nop,wscale 7], length 0
04:59:54.537463 6a:1e:70:73:90:06 > ae:f5:e8:e9:2c:91, ethertype IPv4 (0x0800), length 66: 10.244.0.2.34906 > 172.18.0.2.32000: Flags [.], ack 1, win 502, options [nop,nop,TS val 422097012 ecr 2107699309], length 0
04:59:54.537544 6a:1e:70:73:90:06 > ae:f5:e8:e9:2c:91, ethertype IPv4 (0x0800), length 146: 10.244.0.2.34906 > 172.18.0.2.32000: Flags [P.], seq 1:81, ack 1, win 502, options [nop,nop,TS val 422097012 ecr 2107699309], length 80
04:59:54.537572 ae:f5:e8:e9:2c:91 > 6a:1e:70:73:90:06, ethertype IPv4 (0x0800), length 66: 172.18.0.2.32000 > 10.244.0.2.34906: Flags [.], ack 81, win 509, options [nop,nop,TS val 2107699309 ecr 422097012], length 0
04:59:54.537792 ae:f5:e8:e9:2c:91 > 6a:1e:70:73:90:06, ethertype IPv4 (0x0800), length 302: 172.18.0.2.32000 > 10.244.0.2.34906: Flags [P.], seq 1:237, ack 81, win 509, options [nop,nop,TS val 2107699309 ecr 422097012], length 236
04:59:54.537797 6a:1e:70:73:90:06 > ae:f5:e8:e9:2c:91, ethertype IPv4 (0x0800), length 66: 10.244.0.2.34906 > 172.18.0.2.32000: Flags [.], ack 237, win 501, options [nop,nop,TS val 422097012 ecr 2107699309], length 0
04:59:54.537884 ae:f5:e8:e9:2c:91 > 6a:1e:70:73:90:06, ethertype IPv4 (0x0800), length 125: 172.18.0.2.32000 > 10.244.0.2.34906: Flags [P.], seq 237:296, ack 81, win 509, options [nop,nop,TS val 2107699310 ecr 422097012], length 59
04:59:54.537886 6a:1e:70:73:90:06 > ae:f5:e8:e9:2c:91, ethertype IPv4 (0x0800), length 66: 10.244.0.2.34906 > 172.18.0.2.32000: Flags [.], ack 296, win 501, options [nop,nop,TS val 422097013 ecr 2107699310], length 0
04:59:54.537998 6a:1e:70:73:90:06 > ae:f5:e8:e9:2c:91, ethertype IPv4 (0x0800), length 66: 10.244.0.2.34906 > 172.18.0.2.32000: Flags [F.], seq 81, ack 296, win 501, options [nop,nop,TS val 422097013 ecr 2107699310], length 0
04:59:54.538158 ae:f5:e8:e9:2c:91 > 6a:1e:70:73:90:06, ethertype IPv4 (0x0800), length 66: 172.18.0.2.32000 > 10.244.0.2.34906: Flags [F.], seq 296, ack 82, win 509, options [nop,nop,TS val 2107699310 ecr 422097013], length 0
04:59:54.538170 6a:1e:70:73:90:06 > ae:f5:e8:e9:2c:91, ethertype IPv4 (0x0800), length 66: 10.244.0.2.34906 > 172.18.0.2.32000: Flags [.], ack 297, win 501, options [nop,nop,TS val 422097013 ecr 2107699310], length 0
^C


# 2.Cilium SocketLB[此时是直接发送到后端的80端口，而不是service的32000端口！区别在这里！]
root@cilium-socket-lb-control-plane:~# tcpdump -pne -i lxc2c1ffeae6cf2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on lxc2c1ffeae6cf2, link-type EN10MB (Ethernet), snapshot length 262144 bytes
05:06:10.638605 76:9d:a6:d1:29:d2 > ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), length 42: Request who-has 10.0.1.201 tell 10.0.1.244, length 28
05:06:10.638639 de:ce:bc:97:62:c0 > 76:9d:a6:d1:29:d2, ethertype ARP (0x0806), length 42: Reply 10.0.1.201 is-at de:ce:bc:97:62:c0, length 28
05:06:10.638645 76:9d:a6:d1:29:d2 > de:ce:bc:97:62:c0, ethertype IPv4 (0x0800), length 74: 10.0.1.244.56508 > 10.0.0.73.80: Flags [S], seq 3156935939, win 64240, options [mss 1460,sackOK,TS val 1668902957 ecr 0,nop,wscale 7], length 0
05:06:10.638942 76:9d:a6:d1:29:d2 > de:ce:bc:97:62:c0, ethertype IPv4 (0x0800), length 66: 10.0.1.244.56508 > 10.0.0.73.80: Flags [.], ack 2267397375, win 502, options [nop,nop,TS val 1668902958 ecr 3874334601], length 0
05:06:10.639128 76:9d:a6:d1:29:d2 > de:ce:bc:97:62:c0, ethertype IPv4 (0x0800), length 146: 10.0.1.244.56508 > 10.0.0.73.80: Flags [P.], seq 0:80, ack 1, win 502, options [nop,nop,TS val 1668902958 ecr 3874334601], length 80: HTTP: GET / HTTP/1.1
05:06:10.639557 76:9d:a6:d1:29:d2 > de:ce:bc:97:62:c0, ethertype IPv4 (0x0800), length 66: 10.0.1.244.56508 > 10.0.0.73.80: Flags [.], ack 237, win 501, options [nop,nop,TS val 1668902958 ecr 3874334602], length 0
05:06:10.639788 76:9d:a6:d1:29:d2 > de:ce:bc:97:62:c0, ethertype IPv4 (0x0800), length 66: 10.0.1.244.56508 > 10.0.0.73.80: Flags [.], ack 283, win 501, options [nop,nop,TS val 1668902958 ecr 3874334602], length 0
05:06:10.639985 76:9d:a6:d1:29:d2 > de:ce:bc:97:62:c0, ethertype IPv4 (0x0800), length 66: 10.0.1.244.56508 > 10.0.0.73.80: Flags [F.], seq 80, ack 283, win 501, options [nop,nop,TS val 1668902959 ecr 3874334602], length 0
05:06:10.640375 76:9d:a6:d1:29:d2 > de:ce:bc:97:62:c0, ethertype IPv4 (0x0800), length 66: 10.0.1.244.56508 > 10.0.0.73.80: Flags [.], ack 284, win 501, options [nop,nop,TS val 1668902959 ecr 3874334603], length 0
^C
9 packets captured
9 packets received by filter
0 packets dropped by kernel
root@cilium-socket-lb-control-plane:~# 


