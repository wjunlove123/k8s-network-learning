date
Thu May 18 09:01:41 PM CST 2023
# 1.env info
lsb_release -a
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 22.04.2 LTS
Release:	22.04
Codename:	jammy

kubectl get nodes -o wide
NAME                                 STATUS   ROLES                  AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION      CONTAINER-RUNTIME
cilium-ingress-https-control-plane   Ready    control-plane,master   8m42s   v1.23.4   172.18.0.4    <none>        Ubuntu 21.10   5.19.0-41-generic   containerd://1.5.10
cilium-ingress-https-worker          Ready    <none>                 8m5s    v1.23.4   172.18.0.3    <none>        Ubuntu 21.10   5.19.0-41-generic   containerd://1.5.10
cilium-ingress-https-worker2         Ready    <none>                 8m5s    v1.23.4   172.18.0.2    <none>        Ubuntu 21.10   5.19.0-41-generic   containerd://1.5.10

# 2.Cilium ingress http demo
controller_node=`kubectl get node -o wide --no-headers | grep -E "control-plane|bpf1" | awk -F " " '{print $1}'`
docker cp $controller_node:/minica/minica.pem ./minica.pem

sed -i '/bookinfo\.cilium\.rocks\|hipstershop\.cilium\.rocks/d' /etc/hosts
tee -a /etc/hosts <<<"$(kubectl get svc/cilium-ingress-tls-ingress -o=jsonpath='{.status.loadBalancer.ingress[0].ip}') bookinfo.cilium.rocks hipstershop.cilium.rocks"
172.18.0.201 bookinfo.cilium.rocks hipstershop.cilium.rocks

curl --cacert minica.pem -v https://bookinfo.cilium.rocks/details/1 | jq
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying 172.18.0.201:443...
* Connected to bookinfo.cilium.rocks (172.18.0.201) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
*  CAfile: minica.pem
*  CApath: /etc/ssl/certs
* TLSv1.0 (OUT), TLS header, Certificate Status (22):
} [5 bytes data]
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
} [512 bytes data]
* TLSv1.2 (IN), TLS header, Certificate Status (22):
{ [5 bytes data]
* TLSv1.3 (IN), TLS handshake, Server hello (2):
{ [122 bytes data]
* TLSv1.2 (IN), TLS header, Finished (20):
{ [5 bytes data]
* TLSv1.2 (IN), TLS header, Supplemental data (23):
{ [5 bytes data]
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
{ [6 bytes data]
* TLSv1.3 (IN), TLS handshake, Certificate (11):
{ [839 bytes data]
* TLSv1.3 (IN), TLS handshake, CERT verify (15):
{ [264 bytes data]
* TLSv1.3 (IN), TLS handshake, Finished (20):
{ [52 bytes data]
* TLSv1.2 (OUT), TLS header, Finished (20):
} [5 bytes data]
* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
} [1 bytes data]
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
} [5 bytes data]
* TLSv1.3 (OUT), TLS handshake, Finished (20):
} [52 bytes data]
* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
* ALPN, server did not agree to a protocol
* Server certificate:
*  subject: CN=*.cilium.rocks
*  start date: May 18 12:58:27 2023 GMT
*  expire date: Jun 17 12:58:27 2025 GMT
*  subjectAltName: host "bookinfo.cilium.rocks" matched cert's "*.cilium.rocks"
*  issuer: CN=minica root ca 27c58a
*  SSL certificate verify ok.
* TLSv1.2 (OUT), TLS header, Supplemental data (23):
} [5 bytes data]
> GET /details/1 HTTP/1.1
> Host: bookinfo.cilium.rocks
> User-Agent: curl/7.81.0
> Accept: */*
> 
* TLSv1.2 (IN), TLS header, Supplemental data (23):
{ [5 bytes data]
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
{ [230 bytes data]
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
{ [230 bytes data]
* old SSL session ID is stale, removing
* TLSv1.2 (IN), TLS header, Supplemental data (23):
{ [5 bytes data]
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< content-type: application/json
< server: envoy
< date: Thu, 18 May 2023 13:01:41 GMT
< content-length: 178
< x-envoy-upstream-service-time: 4
< 
{ [178 bytes data]
100   178  100   178    0     0   9823      0 --:--:-- --:--:-- --:--:-- 10470
* Connection #0 to host bookinfo.cilium.rocks left intact
{
  "id": 1,
  "author": "William Shakespeare",
  "year": 1595,
  "type": "paperback",
  "pages": 200,
  "publisher": "PublisherA",
  "language": "English",
  "ISBN-10": "1234567890",
  "ISBN-13": "123-1234567890"
}


